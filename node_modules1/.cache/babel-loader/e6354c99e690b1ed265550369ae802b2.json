{"remainingRequest":"C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\node_modules\\thread-loader\\dist\\cjs.js!C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\node_modules\\babel-loader\\lib\\index.js!C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\src\\views\\AppMain.vue?vue&type=script&lang=js&","dependencies":[{"path":"C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\src\\views\\AppMain.vue","mtime":1555930540116},{"path":"C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1555939801121},{"path":"C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\node_modules\\thread-loader\\dist\\cjs.js","mtime":1555939801471},{"path":"C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\node_modules\\babel-loader\\lib\\index.js","mtime":1555939794798},{"path":"C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1555939801121},{"path":"C:\\inetpub\\wwwroot\\Shipregs2_tst3_k\\js\\vue-cryptoPro-pdf-sign\\node_modules\\vue-loader\\lib\\index.js","mtime":1555939801493}],"contextDependencies":[],"result":["\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _AppGetCertList = _interopRequireDefault(require(\"./AppGetCertList.vue\"));\n\nvar _axios = _interopRequireDefault(require(\"axios\"));\n\nvar _ruscryptojs = require(\"ruscryptojs\");\n\nvar _VueSupport = _interopRequireDefault(require(\"./VueSupport\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nvar _default = {\n  components: {\n    \"app-get-cert-list\": _AppGetCertList.default,\n    \"vue-support\": _VueSupport.default\n  },\n  name: \"app-main\",\n  props: [\"doc_id\", \"backend_url\", \"img_url\"],\n  data: function data() {\n    return {\n      loading_text: \"\",\n      doc_prev: \"\",\n      //\"http://www.edou.ru/upload/learning/3/res26/AU0gg.XoPWc.Image19.jpg\",\n      stamp_img: \"\",\n      //\"http://stamp-pro.ru/assets/cache_image/products/161/variant-i1_280x280_5db.png\",\n      // url:        'https://localhost/wp_simple/cryptopro-pdf-sign-in-browser-with-vuejs/api_dss.php',\n      //url:        '../backend/api_dss.php',\n      HashValue: \"\",\n      cacheObjectId: \"\",\n      createdSign: \"\",\n      msg: \"\",\n      stat: \"\",\n      base64Binary: null,\n      pechat_background: \"\",\n      pechat_pos: {\n        x: 0,\n        y: 0,\n        w: 0,\n        h: 0,\n        opacity: 0\n      },\n      ssid: \"\",\n      cert64: null,\n      selected_sert: null\n    };\n  },\n  mounted: function mounted() {\n    this.saveToStoreAndLocalStorage('saveState'); //без второго аргумента - значит,что берем из локалсторага значение\n\n    window.cryptopro = new _ruscryptojs.CryptoPro();\n    cryptopro.init().then(function (e) {\n      return console.warn(\"[Inited] ruscryptojs->\", e);\n    }).catch(function (e) {\n      return console.log('Ошибка при cryptopro.init()=>', e);\n    });\n    window.axios_instance = _axios.default.create({\n      headers: {\n        crossDomain: true,\n        \"Access-Control-Allow-Origin\": \"*\",\n        Accept: \"application/json\",\n        \"Content-Type\": \"application/json;charset=UTF-8\",\n        responseType: \"json\"\n        /*,responseType: 'json'*/\n\n      }\n    });\n  },\n  methods: {\n    sel_cert_handler: function sel_cert_handler() {\n      this.msg = '';\n      this.stat = '';\n    },\n    loading_handler: function loading_handler(e) {\n      console.log(\"load_handl\", e);\n      this.loading_text = e;\n    },\n    selectPosition: function selectPosition(obj) {\n      this.base64Binary = null;\n      this.cert64 = obj.cert64;\n      this.selected_sert = obj.selected_sert;\n      this.podpisat(1);\n    },\n    selecting_sert: function selecting_sert(e) {\n      console.log(\"ВЫБРАН=>>>>>>>>>\", e);\n      this.base64Binary = \"\";\n      this.doc_prev = \"\";\n      this.stamp_img = \"\";\n      /*флаг на перезагрузку печати*/\n    },\n    previewPechat: function previewPechat(e) {\n      console.log(\"[previewPechat] =>\", e);\n      console.log(\"[842-98-parseInt(e.y)] => \" + (842 - 98 - parseInt(e.y)));\n      this.pechat_pos = e;\n      this.pechat_pos.y = parseInt(842 - 98 - parseInt(e.y)); //дроби не любит ПДФ !онли целое!\n\n      this.pechat_pos.x = parseInt(e.x);\n    },\n    openBase64: function openBase64() {\n      var _this = this;\n\n      var w = window.open(\"about:blank\");\n      setTimeout(function () {\n        //FireFox seems to require a setTimeout for this to work.\n        w.document.body.appendChild(w.document.createElement(\"iframe\")).src = _this.base64Binary;\n      }, 0);\n    },\n    podpisat: function podpisat(stamp_prev) {\n      var _this2 = this;\n\n      //stamp_prev: 0-final, 1-prev;\n      this.loading_text = \"загрузка .... 0/3\";\n      var that = this;\n      var post_data = {\n        cert_base64: this.cert64,\n        pechat_pos: this.pechat_pos,\n        selected_sert: this.selected_sert,\n        doc_id: this.doc_id\n      };\n      var url = \"\".concat(this.backend_url, \"?action=sign&stage=1&stampGen=\").concat(stamp_prev);\n      if (!stamp_prev) url = \"\".concat(url, \"&ssid=\").concat(this.ssid); //если финальная стадия штампа\n\n      axios_instance.post(url, post_data).then(function (res) {\n        console.log(\"stage1=>\", res);\n\n        try {\n          res = eval(\"[\".concat(res.data, \"]\"))[0];\n        } catch (e) {\n          _this2.echo_end_die({\n            stat: 0,\n            msg: \"Ошибка в ответе сервера на первой стадии!\"\n          });\n        }\n\n        if (!res.stat) {\n          throw res.msg;\n        }\n\n        _this2.HashValue = res.HashValue;\n        _this2.cacheObjectId = res.СacheObjectId;\n        _this2.ssid = res.ssid;\n        _this2.loading_text = \"загрузка .... 1/3\";\n\n        _this2.createSign(stamp_prev);\n      }).catch(function (err) {\n        console.log(\"podpisat catch err=>\" + err);\n\n        _this2.echo_end_die({\n          stat: 0,\n          msg: 'Сетевая ошибка!'\n        });\n      });\n    },\n    createSign: function createSign(stamp_prev) {\n      var _this3 = this;\n\n      console.log(\"[createSign] [HashValue] => \" + this.HashValue);\n      var that = this;\n      var Thumbprint = this.selected_sert.Thumbprint;\n      var HashValue = this.HashValue;\n      var cert64 = this.cert64;\n\n      if (!cert64) {\n        throw \"В сертификате отсутствует cert64!\";\n      }\n\n      if (!Thumbprint) {\n        throw \"В сертификате отсутствует Thumbprint!\";\n      } //уходит в кетч,откуда была вызвана етот метод (т.е из createSign -> в вызвавший его podpisat().catch)\n\n\n      console.log(\"thumbprint=>\" + Thumbprint, \"HashValue=>\" + HashValue);\n      cadesplugin.CreateObjectAsync(\"CAdESCOM.Store\").then(function (oStore) {\n        return oStore.Open(cadesplugin.CAPICOM_CURRENT_USER_STORE, cadesplugin.CAPICOM_MY_STORE, cadesplugin.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED).then(function (e2) {\n          oStore.Certificates.then(function (oFnd) {\n            oFnd.Find(cadesplugin.CAPICOM_CERTIFICATE_FIND_SUBJECT_NAME, 'ФГБУ \"\"АМП ПРИМОРСКОГО КРАЯ И ВОСТОЧНОЙ АРКТИКИ\"\"').then(function (oCertificates) {\n              oCertificates.Count.then(function (count) {\n                if (count == 0) {\n                  alert(\"Нет сертификатов с таким именем!!!\");\n                  throw 'Нет сертификатов с таким именем!';\n                }\n\n                oCertificates.Item(1).then(function (oCertificate) {\n                  return window.oCertificate = oCertificate;\n                }).then(function () {\n                  return step2(HashValue);\n                }).catch(function (e) {\n                  return console.log('5');\n                });\n              }).catch(function (e) {\n                return console.log('44444');\n              });\n            }).catch(function (e) {\n              return console.log('33333');\n            });\n          }).catch(function (e) {\n            return console.log('222');\n          });\n        }).catch(function (e) {\n          return console.log('11111111111');\n        });\n      }).catch(function (e) {\n        console.log('ОШИБКА ПРИ STEP2 =>', e);\n        _this3.loading_text = \"ОШИБКА ПРИ STEP1\";\n      });\n\n      function step2(HashValue) {\n        var _this4 = this;\n\n        var backend_HashValue_Base64 = HashValue; //\"Bm74AuKzIhVMtdYtUuJEGn1PBz/JbcNZAnAB1tl/KBE=\" //перекодпировать в бинарный 16х!\n\n        var sHashValue = base64toHEX(backend_HashValue_Base64); //sHashValue = backend_HashValue_Base64;// врубили -> CADESCOM_BASE64_TO_BINARY!!!\n\n        cadesplugin.CreateObjectAsync(\"CAdESCOM.HashedData\").then(function (oHashedData) {\n          oHashedData.propset_Algorithm(cadesplugin.CADESCOM_HASH_ALGORITHM_CP_GOST_3411) //\t\t.then( () => oHashedData.propset_DataEncoding(cadesplugin.CADESCOM_BASE64_TO_BINARY))\n          .then(function () {\n            //debugger;\n            oHashedData.SetHashValue(sHashValue) // данные кодируются при задании или получении значения свойства \n            .then(function () {\n              //debugger;\n              cadesplugin.CreateObjectAsync(\"CAdESCOM.RawSignature\").then(function (oRawSignature) {\n                return oRawSignature.SignHash(oHashedData, oCertificate).then(function (e) {\n                  console.log('last then=>' + e);\n                  cryptoVue.$children[0]._data.createdSign = e;\n                  that.podpisat2(stamp_prev);\n                }).catch(function (e) {\n                  return that.echo_end_die({\n                    stat: 3,\n                    msg: 'Отменено пользователем (1)',\n                    err: e\n                  });\n                });\n              }).catch(function (e) {\n                return that.echo_end_die({\n                  stat: 3,\n                  msg: 'Отменено пользователем (2) ',\n                  err: e\n                });\n              });\n            }).catch(function (e) {\n              return that.echo_end_die({\n                stat: 3,\n                msg: e.message\n              });\n            });\n          }).catch(function (e) {\n            return console.log('bb 11111111111', e);\n          });\n        }).catch(function (e) {\n          console.log('ОШИБКА ПРИ STEP2 =>', e);\n          _this4.loading_text = \"ОШИБКА ПРИ STEP2\";\n        });\n      }\n    },\n    podpisat2: function podpisat2(stamp_prev) {\n      var _this5 = this;\n\n      var data = {\n        HashValue: this.HashValue,\n        pechat_pos: this.pechat_pos,\n        cacheObjectId: this.cacheObjectId,\n        createdSign: this.createdSign.replace(/\\n/gim, ''),\n        selected_sert: this.selected_sert\n      };\n      this.loading_text = \"загрузка .... 2/3\";\n      var url = \"\".concat(this.backend_url, \"?action=sign&stage=2&stampGen=\").concat(stamp_prev, \"&ssid=\").concat(this.ssid);\n      axios_instance.post(url, data).then(function (res) {\n        console.log(\"stage2=>\", res);\n        var d = res.data;\n        if (!d) _this5.echo_end_die({\n          stat: 0,\n          msg: \"Данные не пришли от сервера!\"\n        });\n\n        try {\n          d = eval(\"[\".concat(d, \"]\"))[0];\n        } catch (e) {\n          _this5.echo_end_die({\n            stat: 0,\n            msg: \"Ошибка в ответе сервера во второй стадии.\"\n          });\n        }\n\n        if (!d.base64Binary) {\n          console.log(\"=>Залез в !d.base64Binary\");\n\n          _this5.echo_end_die({\n            stat: 0,\n            msg: \"base64Binary не пришел от сервера!\"\n          });\n        }\n\n        if (stamp_prev == 1) {\n          try {\n            // echo_end_die([\"stat\"=>1,\"base64Binary\"=> $base64Binary,\"doc_prev\"=>$doc_prev]);\n            //that.stamp_img = \"data:image/png;base64,\"+res.data.split('[BREAK]')[0];   //stamp_img\n            //that.doc_prev =  \"data:image/jpg;base64,\"+res.data.split('[BREAK]')[1];   //doc_prev\n            if (!d.doc_prev) {\n              console.log(\"=>Залез в !d.doc_prev\");\n\n              _this5.echo_end_die({\n                stat: 0,\n                msg: \"doc_prev не пришел от сервера!\"\n              });\n            }\n\n            _this5.stamp_img = \"data:image/png;base64,\" + d.base64Binary; //split('[BREAK]')[0];\n\n            _this5.doc_prev = \"data:image/jpg;base64,\" + d.doc_prev; //split('[BREAK]')[1];\n          } catch (err) {\n            console.log(\"podpisat2 try catch err=>\" + err);\n\n            _this5.echo_end_die({\n              stat: 0,\n              msg: \"Ошибка при разборе штампа предпросмотра!\"\n            });\n          }\n        } else {\n          _this5.base64Binary = d.base64Binary;\n          _this5.loading_text = \"\";\n        }\n      }).then(function () {\n        if (stamp_prev == 1) {\n          _this5.loading_text = \"\"; //надо отобразить рисунок до нанесения печати (а то JQUERY не пашет!)\n\n          var that = _this5;\n          $(\"#watermarked\").Watermarker({\n            watermark_img: that.stamp_img,\n            opacity: 1,\n            x: 227,\n            y: 37,\n            w: 236,\n            h: 98,\n            onChange: function (e) {\n              that.previewPechat(e);\n            }.bind(that)\n          });\n        } else _this5.doc_prev = false; // удаляем предпросмотр дока!\n\n      }).catch(function (err) {\n        console.log(\"podpisat2 catch err=>\" + err);\n\n        _this5.echo_end_die({\n          stat: 0,\n          msg: 'Ошибка во второй стадии подписания!'\n        });\n      });\n    },\n    echo_end_die: function echo_end_die(_ref) {\n      var stat = _ref.stat,\n          msg = _ref.msg;\n      console.warn('echo_end_die=>', arguments);\n      if (!stat) swal(\"Ошибка!!\", {\n        className: \"red-bg\",\n        icon: \"error\",\n        text: msg\n      });\n      if (stat == 3) swal(\"Ошибка!!\", {\n        className: \"red-bg\",\n        icon: \"error\",\n        text: msg\n      });\n      this.stat = stat;\n      this.msg = msg;\n      this.loading_text = \"\";\n      throw msg;\n    }\n  }\n};\nexports.default = _default;\n\nfunction base64toHEX(base64) {\n  var raw = atob(base64);\n  var HEX = '';\n\n  for (var i = 0; i < raw.length; i++) {\n    var _hex = raw.charCodeAt(i).toString(16);\n\n    HEX += _hex.length == 2 ? _hex : '0' + _hex;\n  }\n\n  return HEX.toUpperCase();\n}",{"version":3,"sources":["AppMain.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\r\n  <div class=\"appMain\">\r\n\r\n    <div id=\"content-header\">\r\n      <h1 class=\"my-logo\">Сервис электронной подписи ИЦГПК </h1>\r\n      <vue-support  :img_url=\"img_url\"/>\r\n\r\n    </div>\r\n   \r\n  \r\n\r\n      <div class=\"main-content\">\r\n       \r\n      <div class=\"text-center\" v-show=\"loading_text\">\r\n        <div>\r\n          <img :src=\"img_url+'animaatjes-rubiks-cube.gif'\">\r\n        </div>\r\n        <div>{{loading_text}}</div>\r\n      </div>\r\n\r\n      <div v-show=\"!loading_text\">\r\n        <div class=\"text-center\">\r\n          <app-get-cert-list\r\n            :img_url=\"img_url\"\r\n            v-show=\"!doc_prev && !base64Binary\"\r\n            @sel_cert=\"sel_cert_handler\"\r\n            @select-position=\"selectPosition\"\r\n            @loading=\"loading_handler\"\r\n          />\r\n          <button v-show=\"doc_prev\" class=\"btn-3d-1\" @click=\"doc_prev=false\">Выбрать другую подпись</button>\r\n        </div>\r\n\r\n        <transition name=\"slide-fade\">\r\n          <div class=\"pechat\" v-if=\"doc_prev && !base64Binary\">\r\n            <h3>Положение видимой печати:</h3>\r\n\r\n            <img width=\"595\" height=\"842\" :src=\"doc_prev\" id=\"watermarked\">\r\n\r\n            <div class=\"text-center\">\r\n              <p>Подтвердить выставленное положение видимой печати</p>\r\n              <button class=\"btn-3d-2\" @click=\"podpisat(0)\">Подписать</button>\r\n            </div>\r\n          </div>\r\n        </transition>\r\n\r\n        <transition name=\"slide-fade\">\r\n          <div class=\"text-center\" v-if=\"base64Binary\">\r\n            <button\r\n              @click=\"base64Binary=false\"\r\n              class=\"btn-3d-1\"\r\n              width=\"auto\"\r\n              target=\"_blank\"\r\n            >Подписать еще один документ</button>\r\n            <br>\r\n            <br>\r\n            <iframe :src=\"base64Binary\" width=\"790px\" height=\"1290px\" frameborder=\"0\"></iframe>\r\n            <br>\r\n            <br>\r\n            <button @click=\"openBase64\" class=\"btn-3d-1\" width=\"auto\" target=\"_blank\" >Открыть подписанный документ</button>\r\n          </div>\r\n        </transition>\r\n        <!--<p class=\"text-center\" v-if=\"stat==1 || (stat == 0 && stat !== '') \">\r\n              Статус: <span :class=\"{green:stat==1, red:stat!=1}\">{{stat==1?'Успех':'Ошибка'}}</span>\r\n            </p>\r\n            <p class=\"text-center\"  v-if=\"msg\">Сообщение сервера: {{msg}}</p>-->\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport AppGetCertList from \"./AppGetCertList.vue\";\r\nimport axios from \"axios\";\r\nimport { CryptoPro } from \"ruscryptojs\";\r\nimport vue_support from \"./VueSupport\";\r\n\r\n\r\nexport default {\r\n  components: {\r\n    \"app-get-cert-list\": AppGetCertList,\r\n    \"vue-support\": vue_support\r\n  },\r\n  name:\"app-main\",\r\n  props: [\"doc_id\", \"backend_url\", \"img_url\"],\r\n  data() {\r\n    return {\r\n      loading_text: \"\",\r\n      doc_prev: \"\", //\"http://www.edou.ru/upload/learning/3/res26/AU0gg.XoPWc.Image19.jpg\",\r\n      stamp_img: \"\", //\"http://stamp-pro.ru/assets/cache_image/products/161/variant-i1_280x280_5db.png\",\r\n      // url:        'https://localhost/wp_simple/cryptopro-pdf-sign-in-browser-with-vuejs/api_dss.php',\r\n      //url:        '../backend/api_dss.php',\r\n      HashValue: \"\",\r\n      cacheObjectId: \"\",\r\n      createdSign: \"\",\r\n      msg: \"\",\r\n      stat: \"\",\r\n      base64Binary: null,\r\n      pechat_background: \"\",\r\n      pechat_pos: { x: 0, y: 0, w: 0, h: 0, opacity: 0 },\r\n      ssid: \"\",\r\n      cert64: null,\r\n      selected_sert: null\r\n    };\r\n  },\r\n  mounted() {\r\n    this.saveToStoreAndLocalStorage('saveState'); //без второго аргумента - значит,что берем из локалсторага значение\r\n\r\n    window.cryptopro = new CryptoPro();\r\n    cryptopro\r\n    .init().then(e => console.warn(\"[Inited] ruscryptojs->\", e))\r\n    .catch(e=>console.log('Ошибка при cryptopro.init()=>',e));\r\n\r\n    window.axios_instance = axios.create({\r\n      headers: {\r\n        crossDomain: true,\r\n        \"Access-Control-Allow-Origin\": \"*\",\r\n        Accept: \"application/json\",\r\n        \"Content-Type\": \"application/json;charset=UTF-8\",\r\n        responseType: \"json\"\r\n      } /*,responseType: 'json'*/\r\n    });\r\n  },\r\n  methods: {\r\n    sel_cert_handler(){\r\n        this.msg='';\r\n        this.stat='';\r\n    },\r\n    loading_handler(e) {\r\n      console.log(\"load_handl\", e);\r\n      this.loading_text = e;\r\n    },\r\n    selectPosition(obj) {\r\n      this.base64Binary = null;\r\n      this.cert64 = obj.cert64;\r\n      this.selected_sert = obj.selected_sert;\r\n      this.podpisat(1);\r\n    },\r\n    selecting_sert(e) {\r\n      console.log(\"ВЫБРАН=>>>>>>>>>\", e);\r\n      this.base64Binary = \"\";\r\n      this.doc_prev = \"\";\r\n      this.stamp_img = \"\"; /*флаг на перезагрузку печати*/\r\n    },\r\n    previewPechat(e) {\r\n      console.log(\"[previewPechat] =>\", e);\r\n      console.log(\"[842-98-parseInt(e.y)] => \" + (842 - 98 - parseInt(e.y)));\r\n      this.pechat_pos = e;\r\n      this.pechat_pos.y = parseInt(842 - 98 - parseInt(e.y)); //дроби не любит ПДФ !онли целое!\r\n      this.pechat_pos.x = parseInt(e.x);\r\n    },\r\n    openBase64() {\r\n      var w = window.open(\"about:blank\");\r\n      setTimeout(() => {\r\n        //FireFox seems to require a setTimeout for this to work.\r\n        w.document.body.appendChild(\r\n          w.document.createElement(\"iframe\")\r\n        ).src = this.base64Binary;\r\n      }, 0);\r\n    },\r\n\r\n    podpisat(stamp_prev) {\r\n      //stamp_prev: 0-final, 1-prev;\r\n      this.loading_text = \"загрузка .... 0/3\";\r\n      let that = this;\r\n      let post_data = {\r\n        cert_base64: this.cert64,\r\n        pechat_pos: this.pechat_pos,\r\n        selected_sert: this.selected_sert,\r\n        doc_id: this.doc_id\r\n      };\r\n      let url = `${\r\n        this.backend_url\r\n      }?action=sign&stage=1&stampGen=${stamp_prev}`;\r\n      if (!stamp_prev) url = `${url}&ssid=${this.ssid}`; //если финальная стадия штампа\r\n      axios_instance\r\n        .post(url, post_data)\r\n        .then(res => {\r\n          console.log(\"stage1=>\", res);\r\n          try { res = eval(`[${res.data}]`)[0]; } catch (e) { this.echo_end_die({ stat: 0, msg: \"Ошибка в ответе сервера на первой стадии!\" }); }\r\n          if (!res.stat) { throw res.msg; }\r\n          this.HashValue = res.HashValue;\r\n          this.cacheObjectId = res.СacheObjectId;\r\n\r\n          this.ssid = res.ssid;\r\n          this.loading_text = \"загрузка .... 1/3\";\r\n          this.createSign(stamp_prev);\r\n        })\r\n        .catch(err => { \r\n            console.log(\"podpisat catch err=>\" + err); \r\n            this.echo_end_die({ stat: 0, msg: 'Сетевая ошибка!' });\r\n        });\r\n    },\r\n    createSign(stamp_prev) {\r\n      console.log(\"[createSign] [HashValue] => \" + this.HashValue);\r\n      let that = this;\r\n      let Thumbprint = this.selected_sert.Thumbprint;\r\n      let HashValue = this.HashValue;\r\n      let cert64 = this.cert64;\r\n      if (!cert64) {\r\n        throw \"В сертификате отсутствует cert64!\";\r\n      }\r\n      if (!Thumbprint) { throw \"В сертификате отсутствует Thumbprint!\"; } //уходит в кетч,откуда была вызвана етот метод (т.е из createSign -> в вызвавший его podpisat().catch)\r\n      console.log(\"thumbprint=>\" + Thumbprint, \"HashValue=>\" + HashValue);\r\n  \r\n  cadesplugin.CreateObjectAsync(\"CAdESCOM.Store\")\r\n\t.then(oStore=>oStore.Open(cadesplugin.CAPICOM_CURRENT_USER_STORE, cadesplugin.CAPICOM_MY_STORE,cadesplugin.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED)\r\n\t\t.then(e2 => {\r\n\t\t\toStore.Certificates\r\n\t\t\t.then(oFnd => {\r\n\t\t\t\toFnd.Find(cadesplugin.CAPICOM_CERTIFICATE_FIND_SUBJECT_NAME,'ФГБУ \"\"АМП ПРИМОРСКОГО КРАЯ И ВОСТОЧНОЙ АРКТИКИ\"\"')\r\n\t\t\t.then(oCertificates => {\r\n\t\t\toCertificates.Count\r\n\t\t\t.then(count=>{\r\n\t\t\t\tif(count==0) {alert(\"Нет сертификатов с таким именем!!!\"); throw 'Нет сертификатов с таким именем!';}\r\n\t\t\t\toCertificates.Item(1)\r\n\t\t\t\t\t.then(oCertificate=>window.oCertificate=oCertificate)\r\n              .then( () => step2(HashValue) ).catch(e=>console.log('5'))\r\n            }).catch(e=>console.log('44444'))\r\n\t\t\t\t\t}).catch(e=>console.log('33333'))\r\n\t\t\t\t}).catch(e=>console.log('222'))\r\n      }).catch(e=>console.log('11111111111'))\r\n  )\r\n  .catch(e=>{\r\n    console.log('ОШИБКА ПРИ STEP2 =>',e);\r\n    this.loading_text = \"ОШИБКА ПРИ STEP1\";\r\n    \r\n  })\r\n\r\nfunction step2 (HashValue){\r\n  var backend_HashValue_Base64 = HashValue //\"Bm74AuKzIhVMtdYtUuJEGn1PBz/JbcNZAnAB1tl/KBE=\" //перекодпировать в бинарный 16х!\r\n  let sHashValue = base64toHEX(backend_HashValue_Base64);\r\n  //sHashValue = backend_HashValue_Base64;// врубили -> CADESCOM_BASE64_TO_BINARY!!!\r\n  cadesplugin\r\n    .CreateObjectAsync(\"CAdESCOM.HashedData\")\r\n      .then(oHashedData=>{\r\n          oHashedData.propset_Algorithm(cadesplugin.CADESCOM_HASH_ALGORITHM_CP_GOST_3411)\r\n  //\t\t.then( () => oHashedData.propset_DataEncoding(cadesplugin.CADESCOM_BASE64_TO_BINARY))\r\n      .then( \r\n        () => {\r\n          //debugger;\r\n          oHashedData.SetHashValue(sHashValue) // данные кодируются при задании или получении значения свойства \r\n              .then(\r\n                  () =>{\r\n                    //debugger;\r\n                    cadesplugin.CreateObjectAsync(\"CAdESCOM.RawSignature\")\r\n                  .then( oRawSignature => oRawSignature.SignHash(oHashedData, oCertificate)\r\n                    .then(e=>{ console.log('last then=>'+e);\r\n                        cryptoVue.$children[0]._data.createdSign = e;\r\n                        that.podpisat2(stamp_prev);\r\n                    }).catch(e=>that.echo_end_die({ stat: 3, msg: 'Отменено пользователем (1)',err:e}))\r\n                ).catch(e=>that.echo_end_die({ stat: 3, msg: 'Отменено пользователем (2) ',err:e}))\r\n\r\n        }).catch(e=>that.echo_end_die({ stat: 3, msg: e.message }))\r\n      }).catch(e=>console.log('bb 11111111111',e))\r\n      })\r\n      .catch(e=>{\r\n        console.log('ОШИБКА ПРИ STEP2 =>',e);\r\n        this.loading_text = \"ОШИБКА ПРИ STEP2\";\r\n      })\r\n}\r\n    },\r\n\r\n    podpisat2(stamp_prev) {\r\n     \r\n      let data = {\r\n        HashValue: this.HashValue,\r\n        pechat_pos: this.pechat_pos,\r\n        cacheObjectId: this.cacheObjectId,\r\n        createdSign: this.createdSign.replace(/\\n/gim,''),\r\n        selected_sert: this.selected_sert\r\n      };\r\n      this.loading_text = \"загрузка .... 2/3\";\r\n      let url = `${\r\n        this.backend_url\r\n      }?action=sign&stage=2&stampGen=${stamp_prev}&ssid=${this.ssid}`;\r\n      axios_instance\r\n        .post(url, data)\r\n        .then(res => {\r\n          console.log(\"stage2=>\", res);\r\n          let d = res.data;\r\n          if (!d)\r\n            this.echo_end_die({ stat: 0, msg: \"Данные не пришли от сервера!\" });\r\n          try {\r\n            d = eval(`[${d}]`)[0];\r\n          } catch (e) {\r\n            this.echo_end_die({\r\n              stat: 0,\r\n              msg: \"Ошибка в ответе сервера во второй стадии.\"\r\n            });\r\n          }\r\n          if (!d.base64Binary) {\r\n            console.log(\"=>Залез в !d.base64Binary\");\r\n            this.echo_end_die({ stat: 0, msg: \"base64Binary не пришел от сервера!\" });\r\n          }\r\n          if (stamp_prev == 1) {\r\n            try {\r\n              // echo_end_die([\"stat\"=>1,\"base64Binary\"=> $base64Binary,\"doc_prev\"=>$doc_prev]);\r\n              //that.stamp_img = \"data:image/png;base64,\"+res.data.split('[BREAK]')[0];   //stamp_img\r\n              //that.doc_prev =  \"data:image/jpg;base64,\"+res.data.split('[BREAK]')[1];   //doc_prev\r\n              if (!d.doc_prev) {\r\n                console.log(\"=>Залез в !d.doc_prev\");\r\n                this.echo_end_die({\r\n                  stat: 0,\r\n                  msg: \"doc_prev не пришел от сервера!\"\r\n                });\r\n              }\r\n              this.stamp_img = \"data:image/png;base64,\" + d.base64Binary; //split('[BREAK]')[0];\r\n              this.doc_prev = \"data:image/jpg;base64,\" + d.doc_prev; //split('[BREAK]')[1];\r\n            } catch (err) {\r\n                console.log(\"podpisat2 try catch err=>\" + err);\r\n                this.echo_end_die({\r\n                    stat: 0,\r\n                    msg: \"Ошибка при разборе штампа предпросмотра!\"\r\n                }); \r\n            }\r\n          } else {\r\n            this.base64Binary = d.base64Binary;\r\n            this.loading_text = \"\";\r\n          }\r\n        })\r\n        .then(() => {\r\n          if (stamp_prev == 1) {\r\n            this.loading_text = \"\"; //надо отобразить рисунок до нанесения печати (а то JQUERY не пашет!)\r\n            let that = this;\r\n            $(\"#watermarked\").Watermarker({\r\n              watermark_img: that.stamp_img,\r\n              opacity: 1,\r\n              x: 227,\r\n              y: 37,\r\n              w: 236,\r\n              h: 98,\r\n              onChange: function(e) {\r\n                that.previewPechat(e);\r\n              }.bind(that)\r\n            });\r\n          } else this.doc_prev = false; // удаляем предпросмотр дока!\r\n        })\r\n        .catch(err => {\r\n          console.log(\"podpisat2 catch err=>\" + err);\r\n          this.echo_end_die({ stat: 0, msg: 'Ошибка во второй стадии подписания!' });\r\n        });\r\n    },\r\n\r\n    echo_end_die({ stat, msg }) {\r\n        console.warn('echo_end_die=>',arguments);\r\n        if(!stat) swal(\"Ошибка!!\", { className: \"red-bg\", icon: \"error\", text: msg });\r\n\r\n        if(stat==3) swal(\"Ошибка!!\", { className: \"red-bg\", icon: \"error\", text: msg });\r\n        this.stat = stat;\r\n        this.msg = msg;\r\n        this.loading_text = \"\";\r\n        throw msg;\r\n    }\r\n  }\r\n};\r\n\r\n\r\n\r\nfunction base64toHEX(base64) { var raw = atob(base64); var HEX = ''; for (let i = 0; i < raw.length; i++ ) { var _hex = raw.charCodeAt(i).toString(16); HEX += (_hex.length==2?_hex:'0'+_hex); } return HEX.toUpperCase(); }\r\n\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n.pechat {p,h3,button {text-align: center;}}\r\n</style>\r\n\r\n\r\n<style lang=\"scss\">\r\n@import url(../styles/btn.scss);\r\n@import url(../styles/global.scss);\r\n\r\n.swal-overlay {\r\n  background-color: rgba(64, 95, 88, 0.45); /*rgba(43, 165, 137, 0.45);*/\r\n}\r\n.swal-modal {\r\n  /*background-color: rgba(63,255,106,0.69);*/\r\n  border: 3px solid white;\r\n}\r\n\r\n.swal-button {\r\n  padding: 7px 19px;\r\n  border-radius: 2px;\r\n  background-color: #4962b3;\r\n  font-size: 12px;\r\n  border: 1px solid #3e549a;\r\n  text-shadow: 0px -1px 0px rgba(0, 0, 0, 0.3);\r\n}\r\n.swal-button:hover {\r\n  background-color: #1e2b55 !important;\r\n}\r\n.disabled {\r\n  border: 1px solid #999999 !important;\r\n  background-color: #cccccc !important;\r\n  color: #666666 !important;\r\n  &:hover,\r\n  &:active {\r\n    border: 1px solid #999999 !important;\r\n    background-color: #cccccc !important;\r\n    color: #666666 !important;\r\n  }\r\n}\r\n\r\n.text-center {\r\n  text-align: center;\r\n}\r\nbutton { cursor: pointer; }\r\n\r\n.red {\r\n  color: red;\r\n}\r\n.green {\r\n  color: green;\r\n}\r\nimg.watermark {\r\n  cursor: pointer;\r\n  transition: 1s;\r\n  &:hover {\r\n    transform: scale(1.05);\r\n  }\r\n}\r\n\r\n/* Анимации появления и исчезновения могут иметь */\r\n/* различные продолжительности и динамику.       */\r\n.slide-fade-enter-active {\r\n  transition: all 0.3s ease;\r\n}\r\n.slide-fade-leave-active {\r\n  transition: all 0.8s cubic-bezier(1, 0.5, 0.8, 1);\r\n}\r\n.slide-fade-enter, .slide-fade-leave-to\r\n/* .slide-fade-leave-active до версии 2.1.8 */ {\r\n  transform: translateX(10px);\r\n  opacity: 0;\r\n}\r\n</style>\r\n\r\n \r\n<style lang=\"scss\" scoped>\r\n.pechat {\r\n  /*display: flex;\r\n    flex-direction: column;\r\n    align-items: center;*/\r\n  img {\r\n    border: 1px solid black;\r\n    box-shadow: 0px 3px 5px 5px #a59292;\r\n  }\r\n}\r\n.appMain{\r\n    display: flex; \r\n    flex-direction: column; \r\n    .main-content {\r\n        flex:9 1 100%;\r\n        display: flex;\r\n        flex-direction: column;\r\n        align-items: center;\r\n    }\r\n}\r\n$font-stack: Helvetica, sans-serif;\r\n$primary-color: #333;\r\n.appMain {\r\n  font: 100% $font-stack;\r\n  color: $primary-color;\r\n}\r\n@mixin border-radius($radius) {\r\n  -webkit-border-radius: $radius;\r\n  -moz-border-radius: $radius;\r\n  -ms-border-radius: $radius;\r\n  border-radius: $radius;\r\n}\r\ninput {\r\n  @include border-radius(10px);\r\n}\r\n\r\n\r\n</style>\r\n<style>\r\n#content-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n    /*position: relative;*/\r\n    top: -47px;\r\n    width: 100%;\r\n    height: 47px;\r\n    margin-bottom: 1.5em;\r\n    background-image: -webkit-gradient(linear,left 0%,left 100%,from(#304c73),to(#2b4569));\r\n    background-image: -webkit-linear-gradient(top,#304c73,0%,#2b4569,100%);\r\n    background-image: -moz-linear-gradient(top,#304c73 0%,#2b4569 100%);\r\n    background-image: linear-gradient(to bottom,#304c73 0%,#2b4569 100%);\r\n    background-repeat: repeat-x;\r\n    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#304c73',endColorstr='#2b4569',GradientType=0);\r\n    border-bottom: 1px solid #304c73;\r\n    border-top-right-radius: 4px;\r\n    border-top-left-radius: 4px;\r\n}\r\n\r\n.my-logo {\r\n    position: relative;\r\n    left: 20px;\r\n    margin: 0;\r\n    color: #fff;\r\n    font-size: 18px;\r\n    font-weight: lighter;\r\n    line-height: 47px;\r\n    font-family: Helvetica,arial,sans-serif;\r\n    padding-bottom: 28px;\r\n}\r\n\r\n\r\n@media (max-width: 455px) {\r\n  .my-logo {\r\n    font-size: 11px;\r\n  }\r\n}\r\nhtml {\r\n  min-width: 300px;\r\n}\r\n\r\n\r\n</style>\r\n"],"sourceRoot":"src/views"}]}